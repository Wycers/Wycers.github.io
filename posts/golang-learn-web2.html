<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Web 学习（2）——实现中间件(middleware) · Wycer&#39;s blog · QwQ</title>
    <meta name="description" content="花开花落，再灿烂的星光也会消失。">
    <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3F51B5">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/192.png">
  <meta name="msapplication-TileImage" content="/icons/192.png">
  <meta name="msapplication-TileColor" content="#3F51B5">
    
    <link rel="preload" href="/assets/css/styles.b0d9375f.css" as="style"><link rel="preload" href="/assets/js/app.b0d9375f.js" as="script"><link rel="preload" href="/assets/js/42.19c99a73.js" as="script"><link rel="prefetch" href="/assets/js/1.9bac55ce.js"><link rel="prefetch" href="/assets/js/10.0fccaf93.js"><link rel="prefetch" href="/assets/js/11.8285e651.js"><link rel="prefetch" href="/assets/js/12.204817fe.js"><link rel="prefetch" href="/assets/js/13.38904b1e.js"><link rel="prefetch" href="/assets/js/14.d3875814.js"><link rel="prefetch" href="/assets/js/15.f0c91af7.js"><link rel="prefetch" href="/assets/js/16.a2b839b2.js"><link rel="prefetch" href="/assets/js/17.bb852593.js"><link rel="prefetch" href="/assets/js/18.0d9a8cc4.js"><link rel="prefetch" href="/assets/js/19.5e0e13b5.js"><link rel="prefetch" href="/assets/js/2.c118dce5.js"><link rel="prefetch" href="/assets/js/20.b58f8628.js"><link rel="prefetch" href="/assets/js/21.c7367110.js"><link rel="prefetch" href="/assets/js/22.34c06b15.js"><link rel="prefetch" href="/assets/js/23.97b66e2d.js"><link rel="prefetch" href="/assets/js/24.3395d0f0.js"><link rel="prefetch" href="/assets/js/25.fb38d25e.js"><link rel="prefetch" href="/assets/js/26.c8f77286.js"><link rel="prefetch" href="/assets/js/27.fb43c517.js"><link rel="prefetch" href="/assets/js/28.05e657f1.js"><link rel="prefetch" href="/assets/js/29.bd82caad.js"><link rel="prefetch" href="/assets/js/3.0fc009c0.js"><link rel="prefetch" href="/assets/js/30.e7a91386.js"><link rel="prefetch" href="/assets/js/31.1fb824c7.js"><link rel="prefetch" href="/assets/js/32.0c2c5b81.js"><link rel="prefetch" href="/assets/js/33.d9f45cca.js"><link rel="prefetch" href="/assets/js/34.8b1a1b90.js"><link rel="prefetch" href="/assets/js/35.bfb8a69d.js"><link rel="prefetch" href="/assets/js/36.893001da.js"><link rel="prefetch" href="/assets/js/37.5d5d1fbd.js"><link rel="prefetch" href="/assets/js/38.7bedce41.js"><link rel="prefetch" href="/assets/js/39.67872723.js"><link rel="prefetch" href="/assets/js/4.e2663d4d.js"><link rel="prefetch" href="/assets/js/40.9b034a87.js"><link rel="prefetch" href="/assets/js/41.c41458bd.js"><link rel="prefetch" href="/assets/js/43.3e7e0230.js"><link rel="prefetch" href="/assets/js/44.f6ac2b06.js"><link rel="prefetch" href="/assets/js/45.b8b598ed.js"><link rel="prefetch" href="/assets/js/46.48b16736.js"><link rel="prefetch" href="/assets/js/47.11c3adfa.js"><link rel="prefetch" href="/assets/js/48.3563729a.js"><link rel="prefetch" href="/assets/js/49.6cea32d4.js"><link rel="prefetch" href="/assets/js/5.9c36dcff.js"><link rel="prefetch" href="/assets/js/50.b72bf221.js"><link rel="prefetch" href="/assets/js/51.8be703c0.js"><link rel="prefetch" href="/assets/js/52.4b0ad7a8.js"><link rel="prefetch" href="/assets/js/53.551ce7fb.js"><link rel="prefetch" href="/assets/js/54.f96082ce.js"><link rel="prefetch" href="/assets/js/6.14292550.js"><link rel="prefetch" href="/assets/js/7.710cec77.js"><link rel="prefetch" href="/assets/js/8.eba8f4c4.js"><link rel="prefetch" href="/assets/js/9.0cc7f4d1.js">
    <link rel="stylesheet" href="/assets/css/styles.b0d9375f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-app="true" id="app" class="application theme--light"><div class="application--wrap"><div class="progress-linear blog-progress" style="height:3px;display:none;"><div class="progress-linear__background accent" style="height:3px;opacity:0.4;width:100%;"></div><div class="progress-linear__bar"><!----><div class="progress-linear__bar__determinate accent" style="width:0%;"></div></div></div><aside class="navigation-drawer navigation-drawer--close navigation-drawer--fixed navigation-drawer--is-mobile" style="height:100%;margin-top:0px;max-height:calc(100% - 0px);transform:translateX(-240px);width:240px;"><div><div class="aside-brand-wrap"><div class="aside-brand elevation-1"><a href="/" class="aside-avatar elevation-2 router-link-active"><img src="/avatar.jpg" alt="avatar"></a><hgroup class="mt-3 variant-hide aside-group white--text"><div class="headline">Wycer</div><a title="wycers@gmail.com" class="aside-mail white--text">wycers@gmail.com</a><p class="subheading mt-1 aside-description">花开花落，再灿烂的星光也会消失。</p></hgroup></div></div><hr class="divider theme--dark"><div class="list nav-list"><div class="secondary--text"><a href="/" class="list__tile list__tile--link"><div class="list__tile__avatar"><div class="avatar" style="height:40px;width:40px;"><i class="fa fa-home"></i></div></div><div class="list__tile__content">主页</div></a></div><div class="secondary--text"><a href="/essay" class="list__tile list__tile--link"><div class="list__tile__avatar"><div class="avatar" style="height:40px;width:40px;"><i class="fa fa-edit"></i></div></div><div class="list__tile__content">随笔</div></a></div><div class="secondary--text"><a href="/tags" class="list__tile list__tile--link"><div class="list__tile__avatar"><div class="avatar" style="height:40px;width:40px;"><i class="fa fa-tag"></i></div></div><div class="list__tile__content">标签</div></a></div><div class="secondary--text"><a href="/github" class="list__tile list__tile--link"><div class="list__tile__avatar"><div class="avatar" style="height:40px;width:40px;"><i class="fab fa-github"></i></div></div><div class="list__tile__content">Github</div></a></div><div class="secondary--text"><a href="/about" class="list__tile list__tile--link"><div class="list__tile__avatar"><div class="avatar" style="height:40px;width:40px;"><i class="fa fa-user-secret"></i></div></div><div class="list__tile__content">关于</div></a></div></div></div><div class="navigation-drawer__border"></div></aside><nav class="blog-toolbar toolbar toolbar--fixed theme--dark primary" style="margin-top:0px;padding-right:0px;padding-left:0px;transform:translateY(0px);"><div class="toolbar__content" style="height:56px;"><button type="button" class="btn btn--icon"><div class="btn__content"><i class="fa fa-bars"></i></div></button><div class="toolbar__title">Web 学习（2）——实现中间件(middleware)</div><div class="spacer"></div><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><div class="menu" style="display:none;"><div class="menu__activator"><button type="button" class="btn btn--icon"><div class="btn__content"><i class="fa fa-share-alt"></i></div></button></div><div class="menu__content" style="max-height:auto;min-width:0px;max-width:auto;top:12px;left:0px;transform-origin:top right;z-index:0;display:none;"><div class="list"><div class="secondary--text"><a class="list__tile list__tile--link"><div class="list__tile__avatar"><div class="avatar" style="height:40px;width:40px;"><i class="fa fa-lg fa-copy"></i></div></div><div class="list__tile__title">复制链接</div></a></div></div><input type="text" tabindex="-1" aria-hidden="true" value="" class="fake-hide"></div></div></div></nav><main class="content" style="padding-top:56px;padding-right:0px;padding-bottom:0px;padding-left:0px;"><div class="content--wrap"><div class="container blog-container grid-list-xl align-center"><div class="layout row wrap"><div class="flex mb-3 xs12"><article class="card elevation-16 post-card" style="height:auto;"><div class="card__title"><div class="flex xs12"><h2 class="display-1 mb-3">Web 学习（2）——实现中间件(middleware)</h2><div class="post-meta"><time datetime="2018-04-29T12:15:53.000Z" class="secondary--text post-time">2018年04月29日</time></div></div></div><div class="card__text pt-0 pb-0"><div class="flex xs12"><div class="content custom"><p>使用 go 语言的 http 标准库实现中间件</p><h2 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h2><p>昨天我们探讨了 Go 语言使用标准库实现简单的 web 版的 HelloWorld，大致了解了 Go 实现 server 应用的流程，今天我们来探讨一下用 Go 语言实现 http 的 Middleware。</p><p>我们知道，绝大部分 web 应用会将逻辑与功能的实现写在 middleware 里面更整个结构更加分明，middleware 大致在 web 应用里面大致分为两种，即处理 response 和处理 request（个人拙见，如有错误请以指正），接下来我将以处理 request 请求的形式来实现两种 middleware 的写法。</p><h2 id="第一种-以类型的形式实现"><a href="#第一种-以类型的形式实现" aria-hidden="true" class="header-anchor">#</a> 第一种,以类型的形式实现</h2><p>上篇博客中，我们探讨过 Go 语言实现 Web 最核心的部分：</p><pre class="language-go"><code>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8000&quot;</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
</code></pre><p>http 包里面的 ListenAndServe 函数接受两个参数，即监听地址和处理接口 handler，handler 是一个接口，我们需要实现这个接口中的唯一方法 ServeHTTP 便可以实现上述的函数，因此我们处理的整个逻辑和流程都会在这个 handler 里面，下面我们先来看一个最简单的 handler 实现。</p><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;net/http&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">myHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8000&quot;</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span>myHandler<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>上面的代码中我们定义一个 myHandler，它接受 http.ResponseWriter,*http.Request 两个参数然后再向 ResponseWriter 中写入 Hello World,在 main 函数中，我们直接使用了 ListenAndServe 方法监听本地的 8000 端口，注意由于 Go 语言的强类型性，ListenAndServe 的第二个参数类型是 Handler，因此我们想要将 myHandler 传递给 ListenAndServe 就必须实现 ServeHTTP 这个方法。但其实 Go 源码里面已经帮我们实现了这个方法。</p><pre class="language-go"><code><span class="token comment">// Handler that calls f.</span>
<span class="token keyword">type</span> HandlerFunc <span class="token keyword">func</span><span class="token punctuation">(</span>ResponseWriter<span class="token punctuation">,</span> <span class="token operator">*</span>Request<span class="token punctuation">)</span>

<span class="token comment">// ServeHTTP calls f(w, r).</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f HandlerFunc<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">f</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>可以看到，Go 语言将 func(ResponseWriter, *Request)这种类型的函数直接定义了类型 HandlerFunc，而且还实现了 ServeHTTP 这个方法，但是这个方法本身并没有实现任何逻辑，需要我们自己来实现。因此我们实现了 myHandler 这个方法，它将输出一个最简单的 HelloWorld 响应。随后我们可以用 curl 来测试一下：</p><pre class="language-bash"><code>$ <span class="token function">curl</span> localhost:8000
Hello World
</code></pre><p>可以看到，我们通过 curl 请求本地的 8000 端口，返回我们一个 HelloWorld。这便是一个最简单的 Handler 实现了。但是我们的目标是实现中间件，有了上述的所采用的的方法我们就可以大致明白，myHandler 应该作为最后的调用，在它之前才是中间件应该作用的地方，那么我们有了一个大致的方向，我们可以实现一个逻辑用来包含这个 myHandler，但它本身也必须实现 Handler 这个接口，因为我们要把它传递给 ListenAndServe 这个方法。好，我们先大致阐述一下这个中间件的作用，它会拦截一切请求除了这个请求的 host 是我们想要的 host，当然这个 host 有我们定义。</p><pre class="language-go"><code><span class="token keyword">type</span> SingleHost <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	handler     http<span class="token punctuation">.</span>Handler
	allowedHost <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><p>于是我们定义了一个 SingleHost 的结构体，它里面有两个成员一个是 Handler，它将是我们上述的 myHandler，另一个是我们允许来请求 Server 的用户，这个用户他有唯一的 Host，只有当他的 Host 满足我们的要求是才让他请求成功，否则一律返回 403。</p><p>因为我们需要将这个 SingleHost 实例化并传递给 ListenAndServe 这个方法，因此它必须实现 ServeHTTP 这个方法，所以在 ServeHTTP 里面可以直接定义我们用来实现中间件的逻辑。即除非来请求的用户的 Host 是 allowedHost 否则一律返回 403。</p><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>this <span class="token operator">*</span>SingleHost<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>Host <span class="token operator">==</span> this<span class="token punctuation">.</span>allowedHost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		this<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>好，可以清楚的看到只有 Request 的 Host==allowedHost 的时候，我们才调用 handler 的 ServeHTTP 方法，否则返回 403.下面是完整代码：</p><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;net/http&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> SingleHost <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	handler     http<span class="token punctuation">.</span>Handler
	allowedHost <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>this <span class="token operator">*</span>SingleHost<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>Host <span class="token operator">==</span> this<span class="token punctuation">.</span>allowedHost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		this<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">myHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	single <span class="token operator">:=</span> <span class="token operator">&amp;</span>SingleHost<span class="token punctuation">{</span>
		handler<span class="token punctuation">:</span>http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span>myHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
		allowedHost<span class="token punctuation">:</span><span class="token string">&quot;refuse.com&quot;</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8000&quot;</span><span class="token punctuation">,</span> single<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>然后我们用 curl 来请求本地的 8000 端口，</p><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">--head</span> localhost:8000
HTTP/1.1 <span class="token number">403</span> Forbidden
Date: Sun, <span class="token number">21</span> Jan <span class="token number">2018</span> 08:32:47 GMT
Content-Type: text/plain<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
</code></pre><p>可以看到我们在中间件中实现了只允许 host 为 refuse.com 来访问的逻辑实现了，由于 curl 的 Host 是 localhost 所以我们的服务器直接返回了它一个 403。接下来我们改变一下 allowedHost</p><pre class="language-bash"><code>allowedHost:<span class="token string">&quot;localhost:8000&quot;</span>,
</code></pre><p>我们将 allowedHost 变成为 localhost:8000，然后用 curl 测试</p><pre class="language-bash"><code>$ <span class="token function">curl</span> localhost:8000
Hello World
</code></pre><p>可以看到 curl 通过了中间件的并直接获得了 myHandler 返回的 HelloWorld。</p><h2 id="第二种-以函数的形式实现"><a href="#第二种-以函数的形式实现" aria-hidden="true" class="header-anchor">#</a> 第二种,以函数的形式实现</h2><p>好，在上面我们实现了以类型为基础的中间件，可能对 Node.js 较熟悉的人都习惯以函数的形式实现中间件。首先，因为我们是以函数来实现中间件的因此这个函数返回的便是 Handler,它会接受两个参数，一个是我们定义的 myHandler，一个是 allowedHost。</p><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">SingleHost</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> allowedHost <span class="token builtin">string</span><span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
	fn <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> r<span class="token punctuation">.</span>Host <span class="token operator">==</span> allowedHost <span class="token punctuation">{</span>
			handler<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>可以看到，我们在函数内部定义可一个匿名函数 fn，这个匿名函数便是我们要返回的 Handler，如果请求用户的 Host 满足 allowedHost,便可以将调用 myHandler 的函数返回，否则直接返回一个操作 403 的函数。整个代码如下：</p><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;net/http&quot;</span>

<span class="token keyword">func</span> <span class="token function">SingleHost</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> allowedHost <span class="token builtin">string</span><span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
	fn <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> r<span class="token punctuation">.</span>Host <span class="token operator">==</span> allowedHost <span class="token punctuation">{</span>
			handler<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">myHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	single <span class="token operator">:=</span> <span class="token function">SingleHost</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span>myHandler<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;refuse.com&quot;</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8000&quot;</span><span class="token punctuation">,</span> single<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>我们还是通过 curl 来测试一下</p><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">--head</span> localhost:8000
HTTP/1.1 <span class="token number">403</span> Forbidden
Date: Sun, <span class="token number">21</span> Jan <span class="token number">2018</span> 08:45:39 GMT
Content-Type: text/plain<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
</code></pre><p>可以看到由于不满足 refuse.com 的条件，我们会得到一个 403，让我们将 refuse.com 改为 localhost:8000 测试一下。</p><pre class="language-bash"><code>$ <span class="token function">curl</span> localhost:8000
Hello World
</code></pre><p>与刚才一样我们得到了 HelloWorld 这个正确结果。好，我们通过以函数的形式实现了上面同样的功能，当然，这两种方法都可行，主要看个人喜好了，喜欢函数式编程的我还是喜欢后者（笑）。今天就到这里了，祝掘金越办越好！！！</p></div></div></div><div class="card__actions"><div class="flex xs12"><a href="/tags/golang"><span tabindex="0" class="chip capitalize chip-tag chip--label chip--small"><span class="chip__content">golang</span></span></a><a href="/tags/web"><span tabindex="0" class="chip capitalize chip-tag chip--label chip--small"><span class="chip__content">web</span></span></a></div></div></article></div><div class="flex text-xs-left xs6"><a href="/posts/golang-learn-web1.html" class="post-nav btn btn--flat btn--router"><div class="btn__content"><div class="grey--text"><i class="fa mr-1 fa-chevron-left"></i>Prev</div><div class="title mt-1 primary--text hidden-xs-only">Web 学习（1）——标准库 http 实现 server</div></div></a></div><div class="flex text-xs-right xs6"><a href="/posts/test-markdown.html" class="post-nav btn btn--flat btn--router"><div class="btn__content"><div class="grey--text">Next
          <i class="fa ml-1 fa-chevron-right"></i></div><div class="title mt-1 primary--text hidden-xs-only">测试 Markdown</div></div></a></div><div class="flex mt-3 xs12"><div class="card" style="height:auto;"><div class="card__title"><span class="headline">评论区</span></div><div class="container"><div class="gt-container"><div class="gt-initing"><i class="gt-loader"></i><p class="gt-initing-text">Gitalking ...</p></div><!----><!----><div><div class="gt-header"><a class="gt-avatar-github"><span class="gt-ico gt-ico-github"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M64 524C64 719.602 189.356 885.926 364.113 947.017 387.65799 953 384 936.115 384 924.767L384 847.107C248.118 863.007 242.674 773.052 233.5 758.001 215 726.501 171.5 718.501 184.5 703.501 215.5 687.501 247 707.501 283.5 761.501 309.956 800.642 361.366 794.075 387.658 787.497 393.403 763.997 405.637 743.042 422.353 726.638 281.774 701.609 223 615.67 223 513.5 223 464.053 239.322 418.406 271.465 381.627 251.142 320.928 273.421 269.19 276.337 261.415 334.458 256.131 394.888 302.993 399.549 306.685 432.663 297.835 470.341 293 512.5 293 554.924 293 592.81 297.896 626.075 306.853 637.426 298.219 693.46 258.054 747.5 262.966 750.382 270.652 772.185 321.292 753.058 381.083 785.516 417.956 802 463.809 802 513.5 802 615.874 742.99 701.953 601.803 726.786 625.381 750.003 640 782.295 640 818.008L640 930.653C640.752 939.626 640 948.664978 655.086 948.665 832.344 888.962 960 721.389 960 524 960 276.576 759.424 76 512 76 264.577 76 64 276.576 64 524Z"></path>
</svg>
</span><!----></span></a><div class="gt-header-comment"><textarea placeholder="Leave a comment" class="gt-header-textarea"></textarea><div class="gt-header-preview markdown-body hide"></div><div class="gt-header-controls"><a href="https://guides.github.com/features/mastering-markdown/" target="_blank" class="gt-header-controls-tip"><span class="gt-ico gt-ico-tip"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M512 366.949535c-16.065554 0-29.982212 13.405016-29.982212 29.879884l0 359.070251c0 16.167882 13.405016 29.879884 29.982212 29.879884 15.963226 0 29.879884-13.405016 29.879884-29.879884L541.879884 396.829419C541.879884 380.763865 528.474868 366.949535 512 366.949535L512 366.949535z"
    p-id="3083"></path>
  <path d="M482.017788 287.645048c0-7.776956 3.274508-15.553912 8.80024-21.181973 5.525732-5.525732 13.302688-8.80024 21.181973-8.80024 7.776956 0 15.553912 3.274508 21.079644 8.80024 5.525732 5.62806 8.80024 13.405016 8.80024 21.181973 0 7.776956-3.274508 15.656241-8.80024 21.181973-5.525732 5.525732-13.405016 8.697911-21.079644 8.697911-7.879285 0-15.656241-3.274508-21.181973-8.697911C485.292295 303.301289 482.017788 295.524333 482.017788 287.645048L482.017788 287.645048z"
    p-id="3084"></path>
  <path d="M512 946.844409c-239.8577 0-434.895573-195.037873-434.895573-434.895573 0-239.8577 195.037873-434.895573 434.895573-434.895573 239.755371 0 434.895573 195.037873 434.895573 434.895573C946.895573 751.806535 751.755371 946.844409 512 946.844409zM512 126.17088c-212.740682 0-385.880284 173.037274-385.880284 385.777955 0 212.740682 173.037274 385.777955 385.880284 385.777955 212.740682 0 385.777955-173.037274 385.777955-385.777955C897.777955 299.208154 724.740682 126.17088 512 126.17088z"
    p-id="3085"></path>
</svg>
</span><span class="gt-ico-text">Markdown is supported</span></span></a><!----><button class="gt-btn gt-btn-preview"><span class="gt-btn-text">Preview</span><!----></button><button class="gt-btn gt-btn-login"><span class="gt-btn-text">Login with GitHub</span><!----></button></div></div></div><div class="gt-comments"><span></span><p class="gt-comments-null">
              Be the first guy leaving a comment!
          </p><!----></div></div></div></div></div></div></div><div data-v-44f5dfee><aside class="navigation-drawer navigation-drawer--close navigation-drawer--fixed navigation-drawer--is-mobile navigation-drawer--right" style="height:100%;margin-top:0px;max-height:calc(100% - 0px);transform:translateX(180px);width:180px;" data-v-44f5dfee><div data-v-44f5dfee><p data-v-44f5dfee></p><ul class="group-items" data-v-44f5dfee><li class="sidebar-header" data-v-44f5dfee><a href="#前言" class="sidebar-link" data-v-44f5dfee>
            前言
          </a></li><li class="sidebar-header" data-v-44f5dfee><a href="#第一种-以类型的形式实现" class="sidebar-link" data-v-44f5dfee>
            第一种,以类型的形式实现
          </a></li><li class="sidebar-header" data-v-44f5dfee><a href="#第二种-以函数的形式实现" class="sidebar-link" data-v-44f5dfee>
            第二种,以函数的形式实现
          </a></li></ul></div><div class="navigation-drawer__border"></div></aside><button type="button" class="mt-5 btn btn--floating btn--fixed btn--right btn--small btn--top theme--dark blue" data-v-44f5dfee><div class="btn__content"><i aria-hidden="true" class="icon fa fa fa fa-list-ul" data-v-44f5dfee></i></div></button></div></div><footer app="" class="footer blog-footer darken-1 mt-3" style="height:auto;"><div class="primary--text text--lighten-4 text-xs-center py-3 card card--flat card--tile primary" style="height:auto;"><div class="card__text pb-0">
      Released under the MIT License
    </div><div class="card__text pt-0 mt-1"><span>Wycer © 2018 - 2024</span><span><a href="https://beian.miit.gov.cn" target="_blank" rel="noopener noreferrer">
            粤ICP备18027145号-1
          </a><br>
        Power by
        <a href="https://vuepress.vuejs.org" target="_blank" rel="noopener noreferrer">VuePress</a> Theme
        <a href="https://github.com/yscoder/vuepress-theme-indigo" target="_blank" rel="noopener noreferrer">indigo</a></span></div></div></footer></div></main><button type="button" class="btn btn--bottom btn--floating btn--fixed btn--right accent" style="display:none;"><div class="btn__content"><i class="fa fa-lg fa-chevron-up"></i></div></button></div></div></div>
    <script src="/assets/js/app.b0d9375f.js" defer></script><script src="/assets/js/42.19c99a73.js" defer></script>
  </body>
</html>
